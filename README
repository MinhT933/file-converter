# ğŸ§  Golang Service â€” Server & Worker

![Go Version](https://img.shields.io/badge/Go-1.22%2B-blue)
![License](https://img.shields.io/badge/License-MIT-green)
![Docker Support](https://img.shields.io/badge/Docker-Supported-blue)

Monorepo Golang gá»“m hai thÃ nh pháº§n chÃ­nh:

- ğŸŒ `cmd/server`: HTTP/WebSocket API server
- âš™ï¸ `cmd/worker`: background job processor (consumes from queue)

Repo Ã¡p dá»¥ng tÆ° duy Domainâ€‘Driven Design (DDD) trong `internal/`.

---

## âš¡ Quick Start

### 1) YÃªu cáº§u

- **Go â‰¥ 1.22** (LTS)
- **Docker** & **Docker Compose v2** (lá»‡nh `docker compose`)
- (khuyÃªn dÃ¹ng) **pnpm/yarn/npm** náº¿u cÃ³ front-end phá»¥

### 2) CÃ i deps

```bash
go mod tidy
```

### 3) Cháº¡y local (khÃ´ng Docker)

```bash
make run-server   # cháº¡y server: cmd/server/main.go
make run-worker   # cháº¡y worker: cmd/worker/main.go
```

Máº·c Ä‘á»‹nh server bind `:8080`. Má»Ÿ: `http://localhost:8080/health` hoáº·c `http://localhost:8080/swagger/index.html` (náº¿u Ä‘Ã£ mount swagger).

---

## ğŸ§± Build Binaries

Build ra thÆ° má»¥c `./bin`:

```bash
make build-server
make build-worker
# cháº¡y thá»­
./bin/server
./bin/worker
```

DÃ¹ng flags phiÃªn báº£n (Ä‘Ã£ set trong Makefile): `-ldflags "-X main.version=... -X main.commit=... -X main.date=..."`.

---

## ğŸ”§ Environment Variables

Táº¡o file `.env` (hoáº·c `.env.local`) á»Ÿ root:

```env
# Server
PORT=8080
USE_TLS=false
# DB
DB_HOST=postgres
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=123
DB_NAME=file_converter
# Redis & NATS
REDIS_ADDR=redis:6379
NATS_URL=nats://nats:4222
```

> **LÆ°u Ã½**: KhÃ´ng COPY `.env` vÃ o image. Compose Ä‘Ã£ dÃ¹ng `env_file: .env`.

---

## ğŸ³ Docker Dev & Runtime

Repo tÃ¡ch **infra** vÃ  **app** theo 2 file Compose:

- `compose.infra.yml` â†’ Redis, NATS, Postgres, (PgAdmin)
- `compose.app.yml` â†’ app (server) + worker

### 0) Táº¡o external network (1 láº§n)

```bash
docker network create fileconv-net || true
```

### 1) Báº­t háº¡ táº§ng (infra)

```bash
docker compose -f compose.infra.yml up -d
# hoáº·c chá»‰ 1 vÃ i service: redis nats postgres
```

### 2) Dev (hotâ€‘reload báº±ng Air)

> `Dockerfile.server` cÃ³ stage `dev`; `compose.app.yml` Ä‘áº·t `target: ${TARGET:-dev}`

```bash
make app-up TARGET=dev
# xem log
docker compose -f compose.app.yml logs -f app worker
```

Má»Ÿ `http://localhost:8080/health` hoáº·c `http://localhost:8080/swagger/index.html`.

### 3) Runtime (á»•n Ä‘á»‹nh, khÃ´ng hotâ€‘reload)

> DÃ¹ng stage runtime `server-runtime` (binary á»Ÿ `/usr/local/bin`)

```bash
make app-up TARGET=server-runtime
```

### 4) Scale worker

```bash
make scale-worker N=3
```

### 5) Táº¯t services

```bash
make down-all      # táº¯t cáº£ app + infra
# hoáº·c riÃªng láº»
make app-down
make infra-down
```

---

## ğŸ”„ Hotâ€‘reload (Air)

Cáº¥u hÃ¬nh `.air.server.toml` tá»‘i giáº£n á»Ÿ root:

```toml
root = "."
tmp_dir = "tmp"

[build]
cmd = "go build -o /usr/local/bin/myapp-server ./cmd/server"
bin = "/usr/local/bin/myapp-server"
delay = 1000
include_dir = ["cmd","internal"]
exclude_dir = ["docs","vendor","node_modules",".git",".air*","tmp"]

[log]
time = true
```

> Stage `dev` sáº½ `CMD ["air", "-c", ".air.server.toml"]`.

---

## ğŸ“ Project Structure

```
.
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ worker/
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/            # domain, services, repositories, usecases
â”œâ”€â”€ docs/                # swagger docs (náº¿u dÃ¹ng swag)
â”œâ”€â”€ Dockerfile.server    # multi-stage: builder, dev, server-runtime
â”œâ”€â”€ Dockerfile.worker    # multi-stage: builder, runtime
â”œâ”€â”€ compose.infra.yml    # redis, nats, postgres, pgadmin
â”œâ”€â”€ compose.app.yml      # app + worker (dev/prod via build.target)
â”œâ”€â”€ entrypoint.sh        # start server (server-runtime)
â”œâ”€â”€ Makefile             # lá»‡nh tiá»‡n dá»¥ng (dev/prod, scale, logs,...)
â”œâ”€â”€ go.mod / go.sum
â””â”€â”€ README.md
```

---

## ğŸ§ª Tests

```bash
go test ./...
```

---

## ğŸ§° Swagger (tuá»³ chá»n)

Enable routes (vÃ­ dá»¥ Gin):

```go
import swaggerFiles "github.com/swaggo/files"
import ginSwagger "github.com/swaggo/gin-swagger"
r.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))
```

Generate docs (local hoáº·c trong builder stage):

```bash
make swag   # hoáº·c: swag init -g cmd/server/main.go --parseInternal --parseDependency
```

---

## ğŸ” HTTPS/TLS (tuá»³ chá»n)

Trong code:

```go
useTLS := os.Getenv("USE_TLS") == "true"
if useTLS {
    r.RunTLS(":8080", "server.crt", "server.key")
} else {
    r.Run(":8080") // 0.0.0.0:8080
}
```

Trong Compose (táº¯t TLS á»Ÿ dev):

```yaml
environment:
  USE_TLS: "false"
```

---

## ğŸ›Ÿ Troubleshooting

- **`Empty reply from server`**: thÆ°á»ng do gá»i HTTP vÃ o cá»•ng Ä‘ang cháº¡y **HTTPS** hoáº·c server chÆ°a bind `0.0.0.0:8080`. Thá»­ `https://localhost:8080/health` hoáº·c Ä‘áº£m báº£o `r.Run(":8080")`.
- **`no such file or directory: ./myapp-worker`**: bindâ€‘mount Ä‘Ã¨ binary. ÄÃ£ fix báº±ng cÃ¡ch Ä‘áº·t binary á»Ÿ `/usr/local/bin` vÃ  khÃ´ng mount Ä‘Ã¨ thÆ° má»¥c chá»©a binary.
- **`target stage "dev" could not be found`**: Dockerfile khÃ´ng cÃ³ stage `dev`. DÃ¹ng `TARGET=server-runtime` hoáº·c cáº­p nháº­t Dockerfile nhÆ° README nÃ y.
- **Orphan containers**: khÃ¡c project name. ThÃªm `name:` vÃ o má»—i compose file (vd. `fileconv-infra`, `fileconv-app`) vÃ  cháº¡y `--remove-orphans`.
- **CRLF script**: trÃªn Windows dÃ¹ng `sed -i 's/\r$//' entrypoint.sh` (Ä‘Ã£ cÃ³ trong Dockerfile.server) Ä‘á»ƒ trÃ¡nh lá»—i dÃ²ng má»›i.

---

## âœï¸ Author

Created by **[MinhT933](https://github.com/MinhT933)** â€” contributions welcome!

## ğŸ“ License

MIT â€” see `LICENSE`.

note
swag init -g cmd/server/main.go --parseInternal
go run cmd/server/main.go
